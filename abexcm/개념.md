# abexcm 풀이 전 간단한 개념

## PE 파일
윈도우에서는 실행파일을 PE(Portable Executable)파일이라고 부른다. PE파일은 헤더와 바디로 구성되는데, 헤더에 중요정보가 들어있고, 바디에 코드와 데이터가 들어있다. PE에는 exe, dll, ocx등 다양한 종류가 있다.

PE파일을 실행하면 운영체제에 있는 로더가 PE헤더에 있는 정보를 분석해서 PE 바디에 있는 코드와 데이터를 메모리에 배치한다.

메모리는 다음과 같이 구성되어 있다
1. Code : 프로그램 코드가 들어가는 영역
2. Data : 정적변수와 전역변수가 들어가는 영역
3. Stack : 매개변수와 지역변수가 저장되는 영역
4. Heap : 동적 메모리 할당에 사용되는 영역

PE파일이 메모리에 로딩될 때는 코드 영역과 데이터 영역에 자료가 들어간다. 프로그램이 실행되면서 스택 영역과 힙 영역에 데이터가 쌓인다.

PE파일은 처음 실행되는 위치가 정해져 있다. 엔트리포인트(Entry Point)가 PE파일 실행이 시작되는 주소다.

## 레지스터

CPU에서 사용하는 고속의 기억장치이며 CPU가 연산을 수행하기 위해 메모리에 있는 데이터를 레지스터로 가지고 온다.

- **EAX** (Extended Accumulator Register) : 곱셈과 나눗셈 명령에서 사용되며 함수의 반환값을 저장한다.
- **EBX** (Extended Base Register) : ESI나 EDI와 결합해 인덱스에 사용된다.
- **ECX** (Extended Counter Register) : 반복 명령어를 사용할 떄 반복 카운터를 저장한다. ECX 레지스터에 반복할 횟수를 지정해 놓고 반복 작업을 수행한다.
- **EDX** (Extended Data Register) : EAX와 같이 사용되며 부호 확장 명령 등에 활용된다.
- **ESI** (Extended Source Index) : 데이터를 복사하거나 조작할 때 소스 데이터 주소가 저장된다. ESI 레지스터가 가리키는 주소에 있는 데이터를 EDI 레지스터가 가리키는 주소로 복사하는 용도로 많이 사용된다.
- **EDI** (Extended Destination Index) : 복사 작업을 할 떄 목적지 주소가 저장된다. 주로 ESI 레지스터가 가리키는 주소의 데이터가 복사된다.
- **EBP** (Extended Base Pointer) : 하나의 스택 프레임의 시작 주소가 저장된다. 현재 사용되는 스택 프레임이 살아있는 동안 EBP의 값은 변하지 않는다. 현재 사용한 스택 프레임이 사라지면 이전에 사용되던 스택 프레임을 가리키게 된다.
- **ESP** (Extended Stack Pointer) : 하나의 스택 프레임의 끝 지점 주소가 저장된다. PUSH, POP 명령어에 따라서 ESP의 값이 4바이트씩 변한다.
- **EIP** (Extended Instruction Pointer) : 다음에 실행할 명령어가 저장된 메모리 주소가 저장된다. 현재 명령어를 모두 실행한 다음에 EIP 레지스터에 저장된 주소에 있는 명령어를 실행한다. 실행 전에 EIP 레지스터에는 다음 실행해야 할 명령어가 있는 주솟값이 저장된다.

## 스택과 스택 프레임

### 스택
스택은 메모리의 한 부분으로 LIFO 방식으로 동작한다. 스택은 POP과 PUSH 두가지 동작을 지원한다.  
스택의 주소는 스택 포인터라고 풀리는 ESP 레지스터에 저장되어 있다 PUSH를 하면 ESP는 4바이트만큼 감소하면서 데이터가 스택으로 들어간다. POP을 하면 스택으로부터 데이터가 꺼내지고 스택의 주소는 다시 4바이트만큼 증가하게 된다.

프로그램에서 스택은 서브루틴(함수)으로 인자를 전달하고, 서브루틴 내부에서 사용하는 지역변수가 저장되는 공간을 제공하며 서브루틴이 종료될 때 되돌아갈 주소를 저장하는 역할을 한다.

### 스택 프레임
스택프레임은 서브루틴이 가지는 자신만의 스택영역이다. 함수가 호출될 때 스택프레임이 생성되며 함수가 동작을 종료하고 복귀 주소로 돌아갈 때 스택 프레임은 소멸한다. 
1. 서브루틴을 호출할 때 필요한 인자들을 먼저 스택으로 입력한다.
2. 서브루틴을 실행하기 바로 직전에 운영체제는 다시 돌아올 주소인 복귀주소를 스택으로 집어넣는다.
3. 이제부터 스택 프레임이 시작되는데, 먼저 이전 루틴이 사용했던 EBP 레지스터 내용을 스택에 넣는다.
4. EBP 레지스터의 내용이 저장된 위치의 주소를 EBP에 넣는다. 이렇게 설정된 EBP는 스택 프레임에서 데이터 참조를 위한 기준의 주소인 프레임 포인터(Frame Pointer)로 사용된다.

## 어셈블리어
어셈블리어는 연속적인 비트로 구성된 기계어를 사람이 알아볼 수 있도록 만든 일종의 매크로 모음이다.
어셈블리어와 기계어는 1:1로 매칭된다.
이런식으로 사용함
- ADD EAX EBX : EAX = EAX + EBX
- INC ESI = ESI = ESI + 1
- RETN : 스택의 맨 위에 있는 값을 EIP 레지스터에 저장하는 역할을 한다. 서브루틴에서 돌아올 때 주로 사용

## 툴
- OllyDbg : 윈도우용 어셈블러를 분석할 수 있는 디버거
- PEView : 한눈에 PE 구조를 볼 수 있음
- Detect It Easy : PE구조를 보고 개발언어, 패킹여부확인가능, 수정가능
- OllyDumpEx : 메모리 덤프를 위한 OllyDbg 플러그인
